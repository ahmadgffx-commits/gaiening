name: AvicaRDP
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Auto restart every 6 hours

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 350  # Increased time limit
    
    steps:
      - name: Direct Avica Setup
        run: |
          Write-Host "ğŸš€ Starting Avica setup directly..." -ForegroundColor Green
          
          # Download files directly
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/setup.py" -OutFile "setup.py"
          Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat"
          
          # Install Python packages
          python.exe -m pip install requests pyautogui telegraph --quiet
          
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Set user password
          net user runneradmin TheDisa1a
          
          # Start Avica
          Write-Host "âš¡ Starting Avica..." -ForegroundColor Yellow
          python -c "import pyautogui as pag; pag.click(897, 64, duration=2)" 2>$null
          Start-Process "Avica_setup.exe"
          
          # Run setup script
          python setup.py
          
          Write-Host "âœ… Setup completed! Waiting for Avica to load..." -ForegroundColor Green
          Start-Sleep -Seconds 30  # Give Avica time to start

      - name: Setup System User
        run: |
          net user runneradmin TheDisa1a
          Write-Host "âœ… System user configured" -ForegroundColor Green
          
      - name: Show Connection Info
        run: |
          Write-Host "
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        AVICA RDP CONNECTION          â•‘  
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“± WhatsApp: +54
          ğŸ‘¨â€ğŸ’» Created by 
          
          ğŸ“‹ Instructions:
          â€¢ Go to the GoFile link that will appear below
          â€¢ Get Avica ID and Password from there
          â€¢ Download Avica app and connect
          â€¢ GoFile link changes every time!
          
          â³ Waiting for GoFile link...
          " -ForegroundColor Cyan
          
      - name: Start Avica Service
        run: |
          Write-Host "ğŸš€ Starting Avica service in background..." -ForegroundColor Yellow
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c show.bat" -WindowStyle Hidden -Wait
          Write-Host "âœ… Avica service started. Checking output..." -ForegroundColor Green

      - name: Keep Session Active
        run: |
          Write-Host "ğŸš€ Keeping session active in background..." -ForegroundColor Yellow
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c loop.bat" -WindowStyle Hidden
          Start-Sleep -Seconds 10  # Brief pause to ensure process starts

      - name: Capture and Upload Avica Screenshot
        run: |
          Write-Host "ğŸ“¸ Taking screenshot of Avica window..." -ForegroundColor Yellow
          
          # Take screenshot of full screen (captures Avica cleanly)
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap $screen.Width, $screen.Height
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen(0, 0, 0, 0, $screen.Size)
          $graphics.Dispose()
          $bitmap.Save("avica_screenshot.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $bitmap.Dispose()
          
          Write-Host "âœ… Screenshot saved! Now uploading to GoFile..." -ForegroundColor Green
          
          # Upload to GoFile using simple form post
          $boundary = [System.Guid]::NewGuid().ToString()
          $LF = "`r`n"
          $bodyLines = @(
              "--$boundary",
              "Content-Disposition: form-data; name=`"file`"; filename=`"avica_screenshot.png`"$LF",
              "Content-Type: image/png$LF$LF",
              [System.IO.File]::ReadAllBytes("avica_screenshot.png") -join $LF,
              "--$boundary--$LF"
          ) -join $LF
          
          $response = Invoke-RestMethod -Uri "https://gofile.io/uploadFiles" -Method Post -ContentType "multipart/form-data; boundary=$boundary" -Body ([System.Text.Encoding]::UTF8.GetBytes($bodyLines))
          
          # Extract the download page link from response
          $gofileLink = $response.data.downloadPage
          Write-Host "
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          GOFiLE UPLOAD COMPLETE!     â•‘  
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ”— GoFile Link: $gofileLink
          
          ğŸ“‹ Instructions:
          â€¢ Click the link to view/download the screenshot
          â€¢ Get your fresh Avica ID & Password from the image
          â€¢ Connect via Avica app â€“ new creds every 6 hours!
          " -ForegroundColor Cyan
